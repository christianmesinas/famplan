{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}
<div class="container my-4">
  <div class="row">
    {#— Left column: conversation list so you can jump between chats —#}
    <div class="col-md-4">
      <h5>Chats</h5>
      <div class="list-group mb-3">
        {% for convo in conversations %}
          <a
            href="{{ url_for('index', family_id=convo.family.id) }}"
            class="list-group-item list-group-item-action
               {% if convo.family.id == current_family.id %}active{% endif %}"
          >
            {{ convo.family.name }}
            {% if convo.last_post %}
              <br><small class="text-muted">{{ convo.last_post.body|truncate(30) }}</small>
            {% endif %}
          </a>
        {% endfor %}
      </div>
    </div>

    {#— Right column: the actual chat thread —#}
    <div class="col-md-8">
      <h4>Chat: {{ current_family.name }}</h4>

      {#— New message form —#}
      <form method="post">
        {{ form.hidden_tag() }}
        {# hide the family selector (pre-populated in the view) #}
        {{ form.family(class="d-none") }}

        <div class="input-group mb-3">
          {{ form.post(class="form-control", placeholder="Type your message…") }}
          <button class="btn btn-primary" type="submit">
            Send
          </button>
        </div>
      </form>

      {#— Messages scroll area —#}
      <div class="chat-window border rounded p-3" style="height: 60vh; overflow-y: auto; background: #f9f9f9;">
        {% for post in posts %}
          {# Is this your own message? #}
          {% set is_me = post.author.id == get_current_user().id %}

          <div class="d-flex mb-3 {% if is_me %}justify-content-end{% else %}justify-content-start{% endif %}">
            {# For others: avatar on left, bubble to right #}
            {% if not is_me %}
              <img
                src="{{ post.author.avatar(32) }}"
                class="chat-avatar me-2"
                alt="{{ post.author.username }}’s avatar"
              >
            {% endif %}

            <div class="chat-bubble {{ 'chat-bubble--me' if is_me else 'chat-bubble--other' }}">
              <div class="chat-meta mb-1">
                <span class="chat-author">{{ post.author.username }}</span>
                &bull;
                <small class="text-muted">
                  {{ post.local_timestamp.strftime('%-d %b %H:%M') }}
                </small>
              </div>
              <div class="chat-text">{{ post.body }}</div>
            </div>

            {# For your own messages: bubble on left, avatar on right #}
            {% if is_me %}
              <img
                src="{{ post.author.avatar(32) }}"
                class="chat-avatar ms-2"
                alt="Your avatar"
              >
            {% endif %}
          </div>
        {% endfor %}
      </div>

    </div>
  </div>
</div>
{% endblock %}
