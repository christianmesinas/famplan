{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}
<div class="container my-4">
  <div class="row">
    {#— Left column: conversation list so you can jump between chats —#}
    <div class="col-md-4">
      <h5>Chats</h5>
      <div class="list-group mb-3">
        {% for convo in conversations %}
          <a
            href="{{ url_for('index', family_id=convo.family.id) }}"
            class="list-group-item list-group-item-action
               {% if convo.family.id == current_family.id %}active{% endif %}"
          >
            {{ convo.family.name }}
            {% if convo.last_post %}
              <br><small class="text-muted">{{ convo.last_post.body|truncate(30) }}</small>
            {% endif %}
          </a>
        {% endfor %}
      </div>
    </div>

    {#— Right column: the actual chat thread —#}
    <div class="col-md-8">
      <h4>Chat: {{ current_family.name }}</h4>

      {#— New message form —#}
      <form method="post">
        {{ form.hidden_tag() }}
        {# hide the family selector (pre-populated in the view) #}
        {{ form.family(class="d-none") }}

        <div class="input-group mb-3">
          {{ form.post(class="form-control", placeholder="Type your message…") }}
          <button class="btn btn-primary" type="submit">
            Send
          </button>
        </div>
      </form>

      {#— Messages scroll area —#}
      <div class="chat-window border rounded p-3" style="height: 60vh; overflow-y: auto; background: #f9f9f9;">
        {% for post in posts %}
          {# Determine if this post is from the current user #}
          {% set is_me = post.author.id == get_current_user().id %}

          <div class="d-flex mb-3 {% if is_me %}justify-content-end{% else %}justify-content-start{% endif %}">
            <div class="chat-bubble {{ 'chat-bubble--me' if is_me else 'chat-bubble--other' }}">
              <div class="chat-meta mb-1">
                <span class="chat-author">{{ post.author.username }}</span>
                &bull;
                <span class="chat-time">{{ post.timestamp.strftime('%-d %b %H:%M') }}</span>
              </div>
              <div class="chat-text">{{ post.body }}</div>
            </div>
          </div>
        {% endfor %}
      </div>


      {#— Pagination —#}
      <nav aria-label="Message navigation">
        <ul class="pagination">
          <li class="page-item{% if not prev_url %} disabled{% endif %}">
            <a class="page-link" href="{{ prev_url }}">← Newer</a>
          </li>
          <li class="page-item{% if not next_url %} disabled{% endif %}">
            <a class="page-link" href="{{ next_url }}">Older →</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>
{% endblock %}
